---
- name: Deploy aplicatie frontend in K3s
  hosts: master-1
  become: yes
  vars:
    k8s_manifest_path: /root/simple-server-deployment.yaml
    namespace: frontend
    scr_manifest_path: ../k8s/simple-server-deployment.yaml

  tasks:

    - name: Copiaza fisierul de deployment pe master-1
      copy:
        src: "{{ scr_manifest_path }}"
        dest: "{{ k8s_manifest_path }}"
        mode: '0644'

    - name: Aplica manifestul Kubernetes
      command: kubectl apply -f {{ k8s_manifest_path }}
      register: deploy_output

    - name: Afiseaza rezultatul deploy-ului
      debug:
        var: deploy_output.stdout_lines

    - name: Asteapta ca namespace-ul sa fie creat
      command: kubectl get ns {{ namespace }}
      register: ns_check
      retries: 10
      delay: 3
      until: ns_check.rc == 0

    - name: Verifica starea podurilor din namespace-ul {{ namespace }}
      command: kubectl get pods -o wide -n {{ namespace }}
      register: pod_status

    - name: Afiseaza podurile si statusul lor
      debug:
        var: pod_status.stdout_lines

    - name: Afiseaza serviciile disponibile
      command: kubectl get svc -n {{ namespace }}
      register: svc_status

    - name: Arata serviciile create
      debug:
        var: svc_status.stdout_lines

- name: Configureaza NGINX pentru app.itschool.live
  hosts: lb
  become: yes
  vars:
    app_domain: "app.itschool.live"
    email_admin: "admin@itschool.live"

  tasks:
    - name: Asigura-te ca NGINX si Certbot sunt instalate
      apt:
        name:
          - nginx
          - python3-certbot-nginx
        state: present
        update_cache: yes

    - name: Verifica daca exista workeri
      set_fact:
        has_workers: "{{ (groups['worker'] is defined) and (groups['worker'] | length > 0) }}"
      run_once: true

    - name: Anunta lipsa workerilor
      debug:
        msg: "Nu exista workeri in inventory â€” sarim configurarea NGINX!"
      when: not has_workers

    - name: Creeaza configul NGINX pentru {{ app_domain }}
      copy:
        dest: /etc/nginx/conf.d/app-frontend.conf
        content: |
          upstream frontend_app {
          {% for host in groups['worker'] %}
              server {{ hostvars[host].private_ip }}:30081;
          {% endfor %}
          }

          server {
              listen 80;
              server_name {{ app_domain }} www.{{ app_domain }};

              location / {
                  proxy_pass http://frontend_app;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              }
          }
      when: has_workers
      notify: Restart nginx

    - name: Verifica si genereaza certificat HTTPS pentru {{ app_domain }}
      command: >
        certbot --nginx -d {{ app_domain }} -d www.{{ app_domain }}
        --non-interactive --agree-tos -m {{ email_admin }}
        --redirect
      register: certbot_result
      changed_when: "'Congratulations' in certbot_result.stdout or 'Renewal' in certbot_result.stdout"
      failed_when: false

    - name: Afiseaza rezultatul Certbot
      debug:
        var: certbot_result.stdout_lines

  handlers:
    - name: Restart nginx
      service:
        name: nginx
        state: restarted
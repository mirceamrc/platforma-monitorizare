---
- name: Configurare NGINX Load Balancer pentru K3s
  hosts: lb
  become: yes
  vars:
    app_domain: "itschool.live"
    email_admin: "admin@itschool.live"

  tasks:
    - name: Se verifica NGINX si Certbot daca sunt instalate
      apt:
        name:
          - nginx
          - python3-certbot-nginx
        state: present
        update_cache: yes

    - name: Se dezactiveaza site-ul implicit NGINX
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      ignore_errors: yes

    - name: Adauga blocul stream pentru K3s API in nginx.conf
      blockinfile:
        path: /etc/nginx/nginx.conf
        marker: "# {mark} ANSIBLE K3S STREAM BLOCK"
        block: |
          stream {
              upstream k3s_servers {
              {% if groups['master'] | length > 0 %}
              {% for host in groups['master'] %}
                  server {{ hostvars[host].ansible_host }}:6443;
              {% endfor %}
              {% else %}
                  # niciun master definit
              {% endif %}
              }

              server {
                  listen 6443;
                  proxy_pass k3s_servers;
              }
          }
      notify: Restart nginx

    - name: Verifica daca exista workeri
      set_fact:
        has_workers: "{{ (groups['worker'] is defined) and (groups['worker'] | length > 0) }}"
      run_once: true

    - name: Anunta lipsa workerilor
      debug:
        msg: "Nu exista workeri in inventory — sarim configurarea NGINX pentru aplicatie!"
      when: not has_workers

    - name: Creeaza configul NGINX pentru app monitoring
      copy:
        dest: /etc/nginx/conf.d/app.conf
        content: |
          upstream monitoring_app {
          {% for host in groups['worker'] %}
              server {{ hostvars[host].ansible_host }}:30080;
          {% endfor %}
          }

          server {
              listen 80;
              server_name itschool.live www.itschool.live;

              location / {
                  proxy_pass http://monitoring_app;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              }
          }
      when: has_workers
      notify: Restart nginx

    - name: Se verifica daca DNS-ul itschool.live pointeaza spre load balancer
      shell: dig +short itschool.live | grep -w "{{ ansible_host }}"
      register: dns_check
      ignore_errors: yes

    - name: Afiseaza rezultatul DNS
      debug:
        msg: >
          {% if dns_check.rc == 0 %}
          Domeniul itschool.live pointeaza corect catre {{ ansible_host }}.
          {% else %}
          DNS-ul itschool.live nu pointeaza catre {{ ansible_host }} — Certbot va fi sarit.
          {% endif %}

    - name: Se activeaza HTTPS cu Let's Encrypt (Certbot)
      command: >
        certbot --nginx -d {{ app_domain }} -d www.{{ app_domain }}
        --non-interactive --agree-tos -m {{ email_admin }} --redirect
      when: dns_check.rc == 0 and has_workers
      ignore_errors: yes

    - name: Se verifica configurarea NGINX
      command: nginx -t
      register: nginx_test
      when: has_workers
      changed_when: false

    - name: Rezultatul configurarii
      debug:
        msg: "{{ nginx_test.stdout_lines }}"
      when: has_workers

  handlers:
    - name: Restart nginx
      service:
        name: nginx
        state: restarted

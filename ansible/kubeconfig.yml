---
- name: Copiaza si configureaza kubeconfig si kubectl pe masina locala
  hosts: master[0]
  become: true
  vars:
    cluster_name: "itschool-cluster"

  tasks:
    - name: Creeaza directorul local pentru kubeconfig
      delegate_to: localhost
      become: false
      file:
        path: "{{ lookup('env','HOME') }}/.kube"
        state: directory
        mode: '0700'

    - name: Copiaza fisierul kubeconfig de pe master
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ lookup('env','HOME') }}/.kube/k3s.yaml"
        flat: yes

    - name: Inregistreaza IP-ul primului load balancer
      set_fact:
        lb_ip: "{{ hostvars[groups['lb'][0]].ansible_host }}"

    - name: Afiseaza IP-ul load balancerului detectat
      delegate_to: localhost
      become: false
      debug:
        msg: "IP-ul load balancerului este {{ lb_ip }}"

    - name: Inlocuieste adresa localhost cu IP-ul load balancerului
      delegate_to: localhost
      become: false
      ansible.builtin.replace:
        path: "{{ lookup('env','HOME') }}/.kube/k3s.yaml"
        regexp: 'server: https://127\.0\.0\.1:6443'
        replace: "server: https://{{ lb_ip }}:6443"

    - name: Schimba numele clusterului si contextului din default in {{ cluster_name }}
      delegate_to: localhost
      become: false
      ansible.builtin.replace:
        path: "{{ lookup('env','HOME') }}/.kube/k3s.yaml"
        regexp: '\bdefault\b'
        replace: "{{ cluster_name }}"

    - name: Muta fisierul in ~/.kube/config (default kubeconfig)
      delegate_to: localhost
      become: false
      ansible.builtin.command: >
        mv {{ lookup('env','HOME') }}/.kube/k3s.yaml {{ lookup('env','HOME') }}/.kube/config
      args:
        removes: "{{ lookup('env','HOME') }}/.kube/k3s.yaml"

    - name: Verifica daca kubectl este instalat
      delegate_to: localhost
      become: false
      ansible.builtin.command: which kubectl
      register: kubectl_check
      ignore_errors: true

    - name: Instaleaza kubectl local (Ubuntu/Debian)
      delegate_to: localhost
      become: true
      when: kubectl_check.rc != 0
      block:
        - name: Obtine ultima versiune kubectl
          ansible.builtin.shell: |
            curl -L -s https://dl.k8s.io/release/stable.txt
          register: kubectl_version
          changed_when: false

        - name: Descarca kubectl
          ansible.builtin.get_url:
            url: "https://dl.k8s.io/release/{{ kubectl_version.stdout }}/bin/linux/amd64/kubectl"
            dest: /usr/local/bin/kubectl
            mode: '0755'

    - name: Testeaza conexiunea la cluster
      delegate_to: localhost
      become: false
      ansible.builtin.command: kubectl get nodes
      register: cluster_test
      ignore_errors: true

    - name: Afiseaza rezultatul conexiunii
      delegate_to: localhost
      become: false
      ansible.builtin.debug:
        msg: "{{ cluster_test.stdout | default('Nu s-a putut conecta la cluster.') }}"
